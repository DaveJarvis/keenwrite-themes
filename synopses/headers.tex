% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%
% Configure headers and footers.
%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\setupheadertexts[]

\startsetups[TextHeaderLeftLeft]
  \ss
  \leftaligned{Chapter \getmarking[chapternumber]: \getmarking[chapter]}
\stopsetups

\startsetups[TextHeaderLeftRight]
  \ss
  \rightaligned{Storyline \rawcountervalue[TextCounterOverview]}
\stopsetups

\startsetups[TextHeaderRight]
  \midaligned{\ss \documentvariable{title}}
\stopsetups

\setupheadertexts
  [\setups{TextHeaderLeftLeft}][\setups{TextHeaderLeftRight}]
  [][\setups{TextHeaderRight}]

% Calculate the percentage complete for a progress meter.
\doifmodeelse{*first} {
  \definemeasure[TextPercentComplete][\zeropoint]
} {
  \definemeasure[TextPercentComplete][\textwidth*\currentpage/\lastpage]
}

\define\TextPageNumber{%
  \inframed[
    frame=off,
    topframe=on,
    bottomframe=off,
    width=\measure{TextPercentComplete},
    framecolor=TextColourTertiaryLt,
  ]{\currentpage\ of \lastpage}
}

\startsetups[TextFooterLeft]
  \midaligned{\ss \TextPageNumber}
\stopsetups

\startsetups[TextFooterRight]
  \midaligned{\ss \TextPageNumber}
\stopsetups

\setupfootertexts[\setups{TextFooterLeft}][] [][\setups{TextFooterRight}]

